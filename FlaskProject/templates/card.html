{% extends 'index.html' %}
{% block content %}
<!-- Иконки в правом верхнем углу -->
<div class="icon-container">
    <a href="/money">
        <img class="img1" src="../static/img/home.png" alt="Назад">
    </a>
    <a href="/logout">
        <img class="img1" src="../static/img/exit.png" alt="Выход">
    </a>
</div>

<div class="goal-header">
    <div class="goal-title">
        <h1>{{ n.title }}</h1>
        <div class="goal-status {{ 'completed' if n.status == 'достигнута' else 'in-progress' }}">
            Цель {{ n.status }}
        </div>
    </div>
</div>

{% with messages = get_flashed_messages() %}
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-success">{{ message }}</div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="goal-stats">
    <div class="stat-card">
        <div class="stat-label">Итоговая сумма</div>
        <div class="stat-value">{{ n.sum_ }} ₽</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Текущий баланс</div>
        <div class="stat-value balance">{{ n.balance }} ₽</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Категория</div>
        <div class="stat-value category">{{ n.cat }}</div>
    </div>
</div>

{% if n.user == session["user"] %}
<div class="action-buttons">
    <a href="/update/{{ n.id }}" class="btn btn-primary">Обновить цель</a>
    <a href="/delete/{{ n.id }}" class="btn btn-danger" onclick="return confirm('Вы точно хотите удалить накопление? После этого его нельзя будет восстановить.')">Удалить цель</a>
</div>
{% endif %}

{% if n.status == 'не достигнута' %}
<div class="balance-controls">
    <h3>Управление балансом</h3>
    <form action="/plus/{{ n.id }}" method="post">
        <div class="balance-inputs">
            <input type="number" id="balanceAmount" placeholder="Введите сумму" min="1" name="b" required>
            <div class="balance-actions">
                <button type="submit" class="btn-balance increase">Увеличить</button>
                <button type="submit" class="btn-balance decrease" formaction="/minus/{{ n.id }}">Уменьшить</button>
            </div>
        </div>
    </form>
</div>

{% if n.user != session["user"] %}
<div class="action-buttons">
    <a href="/del_user/{{ n.id }}/{{ session['user'] }}" class="btn btn-danger" onclick="return confirm('Вы точно хотите выйти из накопления?')">Выйти</a>
</div>
{% endif %}

{% if n.user == session["user"] %}
<div class="collaborators-section">
    <h3>Совместные накопления</h3>

    <!-- Форма добавления участника -->
    <div class="form-group">
        <form action="/add_user/{{ n.id }}" method="post" class="collaborator-form">
            <label for="u">Логин пользователя</label>
            <input type="text"
                   id="u"
                   name="u"
                   required>
            <button type="submit" class="btn">Добавить участника</button>
        </form>
    </div>

    <!-- Список текущих соавторов -->
    {% if n.users %}
    <div class="collaborators-list">
        <h4>Участники ({{ n.users.split(', ')|length }})</h4>
        <div class="users-grid">
            {% for user_login in n.users.split(', ') %}
            <div class="user-item">
                <span class="username">{{ user_login }}</span>
                <a href="/del_user/{{ n.id }}/{{ user_login }}"
                   class="btn btn-danger btn-small"
                   onclick="return confirm('Удалить {{ user_login }} из накопления?')">×</a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="empty-state">
        <p>Никто еще не присоединился к накоплению</p>
    </div>
    {% endif %}
</div>
{% endif %}
{% endif %}
{% endblock %}