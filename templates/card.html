{% extends 'index.html' %}
{% block content %}
<!-- –ò–∫–æ–Ω–∫–∏ –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É -->
<div class="icon-container">
    <a href="/money">
        <img class="img1" src="../static/img/home.png" alt="–ù–∞–∑–∞–¥">
    </a>
    <a href="/logout">
        <img class="img1" src="../static/img/exit.png" alt="–í—ã—Ö–æ–¥">
    </a>
    <a href="#" class="theme-toggle">
        <img class="img1" src="/static/img/set.png" alt="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
    </a>
</div>

<div class="goal-header">
    <div class="goal-image">
        <img src="/static/img/goal.png" alt="–¶–µ–ª—å" class="goal-img">
    </div>
    <div class="goal-content">
        <div class="goal-title">
            <h1>{{ n.title }}</h1>
            <div class="goal-status {{ 'completed' if n.status == '–¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞' else 'in-progress' }}">
                –¶–µ–ª—å {{ n.status }}
            </div>
        </div>
    </div>
</div>

{% with messages = get_flashed_messages() %}
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-success">{{ message }}</div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="goal-stats">
    <div class="stat-tile sum-tile">
        <span class="stat-label">–ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞</span>
        <span class="stat-value">{{ n.sum_ }} ‚ÇΩ</span>
    </div>
    <div class="stat-tile sum-tile">
        <span class="stat-label">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</span>
        <span class="stat-value balance">{{ n.balance }} ‚ÇΩ</span>
    </div>
    <div class="stat-tile sum-tile">
        <span class="stat-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</span>
        <span class="stat-value category">{{ n.cat }}</span>
    </div>
    <div class="stat-tile sum-tile">
        <span class="stat-label">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ</span>
        <span class="stat-value category">{{ n.change }}</span>
    </div>
</div>

{% if n.user == session["user"] %}
<div class="action-buttons">
    <a href="/update/{{ n.id }}" class="btn btn-primary">–û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–ª—å</a>
    <a href="/delete/{{ n.id }}" class="btn btn-danger" onclick="return confirm('–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ? –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –µ–≥–æ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å.')">–£–¥–∞–ª–∏—Ç—å —Ü–µ–ª—å</a>
</div>
{% endif %}

{% if n.status == '–Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞' %}
<div class="balance-controls">
    <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–º</h3>
    <form action="/plus/{{ n.id }}" method="post">
        <div class="balance-inputs">
            <input type="number" id="balanceAmount" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" min="1" name="b" required>
            <div class="balance-actions">
                <button type="submit" class="btn-balance increase">–£–≤–µ–ª–∏—á–∏—Ç—å</button>
                <button type="submit" class="btn-balance decrease" formaction="/minus/{{ n.id }}">–£–º–µ–Ω—å—à–∏—Ç—å</button>
            </div>
        </div>
    </form>
</div>

{% if n.user == session["user"] %}
<div class="collaborators-section">
    <h3>–°–æ–≤–º–µ—Å—Ç–Ω—ã–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è</h3>

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞ -->
    <div class="form-group">
        <form action="/add_user/{{ n.id }}" method="post" class="collaborator-form">
            <label for="u">–õ–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
            <input type="text"
                   id="u"
                   name="u"
                   required>
            <button type="submit" class="btn">–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</button>
        </form>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ —Ç–µ–∫—É—â–∏—Ö —Å–æ–∞–≤—Ç–æ—Ä–æ–≤ -->
    {% if n.users %}
    <div class="collaborators-list">
        <h4>–£—á–∞—Å—Ç–Ω–∏–∫–∏ ({{ n.users.split(', ')|length }})</h4>
        <div class="users-grid">
            {% for user_login in n.users.split(', ') %}
            <div class="user-item">
                <span class="username">{{ user_login }}</span>
                <a href="/del_user/{{ n.id }}/{{ user_login }}"
                   class="btn btn-danger btn-small"
                   onclick="return confirm('–£–¥–∞–ª–∏—Ç—å {{ user_login }} –∏–∑ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è?')">√ó</a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="empty-state">
        <p>–ù–∏–∫—Ç–æ –µ—â–µ –Ω–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—é</p>
    </div>
    {% endif %}
</div>
{% endif %}
{% endif %}

<!-- –ò–°–¢–û–†–ò–Ø + –ì–†–ê–§–ò–ö - –†–ê–ë–û–ß–ê–Ø –í–ï–†–°–ò–Ø -->
<div class="history-chart-container">
    <div class="history-chart-wrapper">
        <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å - –ò—Å—Ç–æ—Ä–∏—è -->
        <div class="history-section">
            <h3 class="chart-title">üìä –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</h3>
            {% if tr %}
            <div class="history-list" id="historyList">
                {% for i in tr %}
                <div class="history-item {{ 'increase' if i.operation == '+' else 'decrease' }}"
                     data-date="{{ i.change }}"
                     data-amount="{{ i.sum_ }}"
                     data-operation="{{ i.operation }}">
                    <div class="history-info">
                        <span class="history-icon">{{ i.operation }}</span>
                        <span class="history-amount">{{ i.sum_ }} ‚ÇΩ</span>
                        <span class="history-date">{{ i.change }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">üìä</div>
                <p>–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—É—Å—Ç–∞</p>
            </div>
            {% endif %}
        </div>

        <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å - –ì—Ä–∞—Ñ–∏–∫ -->
        <div class="chart-section">
            <h3 class="chart-title">üìà –ü—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è</h3>
            <div class="chart-container">
                <canvas id="balanceChart"></canvas>
            </div>
        </div>
    </div>
</div>
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const historyList = document.getElementById('historyList');
    if (!historyList || historyList.children.length === 0) {
        console.log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞');
        return;
    }

    const historyItems = document.querySelectorAll('.history-item');
    const goalSumElement = document.querySelector('.stat-value'); // –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞
    const goalSumText = goalSumElement ? goalSumElement.textContent.replace(' ‚ÇΩ', '').replace(/,/g, '') : 0;
    const maxBalance = parseFloat(goalSumText) || 10000;

    console.log('–ù–∞–π–¥–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏—Å—Ç–æ—Ä–∏–∏: ' + historyItems.length);
    console.log('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å —Ü–µ–ª–∏: ' + maxBalance);

    const labels = [];
    const balanceData = [];
    const colors = [];
    let currentBalance = 0;

    Array.from(historyItems).forEach(function(item) {
        const date = item.dataset.date || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        const amount = parseFloat(item.dataset.amount) || 0;
        const operation = item.dataset.operation;

        // –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø: 0 <= –±–∞–ª–∞–Ω—Å <= –∏—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞
        currentBalance += (operation === '+' ? amount : -amount);
        currentBalance = Math.max(0, Math.min(currentBalance, maxBalance));

        labels.push(date);
        balanceData.push(Math.round(currentBalance));
        colors.push(operation === '+' ? '#57B446' : '#FF6B35');
    });

    console.log('–î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞: ', { labels: labels, balanceData: balanceData });

    const canvas = document.getElementById('balanceChart');
    if (!canvas) {
        console.error('Canvas –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        return;
    }

    const ctx = canvas.getContext('2d');

    if (window.balanceChartInstance) {
        window.balanceChartInstance.destroy();
    }

    window.balanceChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '–ë–∞–ª–∞–Ω—Å',
                data: balanceData,
                borderColor: '#57B446',
                backgroundColor: 'rgba(87, 180, 70, 0.15)',
                borderWidth: 4,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: colors,
                pointBorderColor: '#fff',
                pointBorderWidth: 3,
                pointRadius: 8,
                pointHoverRadius: 12
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.9)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    cornerRadius: 8,
                    callbacks: {
                        label: function(context) {
                            return '–ë–∞–ª–∞–Ω—Å: ' + context.parsed.y.toLocaleString() + ' ‚ÇΩ';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: maxBalance,
                    grid: { color: 'rgba(0,0,0,0.05)' },
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + ' ‚ÇΩ';
                        }
                    }
                },
                x: {
                    grid: { display: false }
                }
            },
            animation: {
                duration: 1500,
                easing: 'easeOutQuart'
            }
        }
    });

    console.log('–ì—Ä–∞—Ñ–∏–∫ —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏!');
});
</script>

{% if n.status == '–Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞' %}
<script>
// –ü–†–ï–î–°–ö–ê–ó–ê–ù–ò–ï —Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –¥–∞—Ç –∏ –¥–∞–Ω–Ω—ã—Ö
document.addEventListener('DOMContentLoaded', function() {
    const historyItems = document.querySelectorAll('.history-item');
    const goalSumElement = document.querySelector('.stat-value');

    if (historyItems.length === 0 || !goalSumElement) {
        showPredictionError('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞');
        return;
    }

    // –ü–∞—Ä—Å–∏–º —Ü–µ–ª—å
    const goalSumText = goalSumElement.textContent.replace(/[^d]/g, '');
    const goalSum = parseFloat(goalSumText);
    if (isNaN(goalSum) || goalSum <= 0) {
        showPredictionError('–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Å—É–º–º–∞ —Ü–µ–ª–∏');
        return;
    }

    // –°–æ–±–∏—Ä–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
    const history = Array.from(historyItems).map(item => ({
        date: item.dataset.date,
        amount: parseFloat(item.dataset.amount) || 0,
        operation: item.dataset.operation
    })).filter(item => item.amount > 0); // –¢–æ–ª—å–∫–æ —Ä–µ–∞–ª—å–Ω—ã–µ —Å—É–º–º—ã

    if (history.length < 3) {
        showPredictionError('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö (–º–∏–Ω–∏–º—É–º 3 –æ–ø–µ—Ä–∞—Ü–∏–∏)');
        return;
    }

    // –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å
    let currentBalance = 0;
    history.forEach(item => {
        if (item.operation === '+') currentBalance += item.amount;
        else currentBalance -= item.amount;
        currentBalance = Math.max(0, currentBalance);
    });

    if (currentBalance >= goalSum) {
        showPredictionSuccess('üéâ –¶–µ–ª—å —É–∂–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!');
        return;
    }

    // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5-10 –æ–ø–µ—Ä–∞—Ü–∏–π
    const recentCount = Math.min(10, history.length);
    const recent = history.slice(-recentCount);
    const recentAdds = recent.filter(item => item.operation === '+');

    if (recentAdds.length === 0) {
        showPredictionError('–ù–µ—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π –∑–∞ –ø–µ—Ä–∏–æ–¥');
        return;
    }



    const netGain = recentAdds.reduce((sum, item) => sum + item.amount, 0);

    const daysPeriod = recentCount;

    const dailyRate = Math.round(netGain / daysPeriod);



    if (dailyRate <= 0) {

        showPredictionError('–°–∫–æ—Ä–æ—Å—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è —Å–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∞—è');

        return;

    }



    const remaining = goalSum - currentBalance;

    const daysNeeded = Math.ceil(remaining / dailyRate);



    // ‚ùå –ü–†–û–í–ï–†–ö–ê –ü–†–û–®–ï–î–®–ï–ô –î–ê–¢–´

    const lastDate = new Date(history[0].date);

    const today = new Date();

    const predictedDate = new Date(lastDate.getTime() + daysNeeded * 24 * 60 * 60 * 1000);



    if (predictedDate < today) {

        showPredictionWarning('–î–∞—Ç–∞ –≤ –ø—Ä–æ—à–ª–æ–º - —É–≤–µ–ª–∏—á—å—Ç–µ —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π!');

        return;

    }



    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É

    const options = { day: 'numeric', month: 'short', year: 'numeric' };

    const formattedDate = predictedDate.toLocaleDateString('ru-RU', options);



    // –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å

    const confidence = Math.min(90, Math.max(25, 100 - (daysNeeded / 8)));



    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç

    setTimeout(() => {

        document.querySelector('.prediction-loading').style.display = 'none';

        document.getElementById('predictionResult').style.display = 'block';



        document.getElementById('predictedDate').textContent = formattedDate;

        document.getElementById('dailyRate').textContent = dailyRate.toLocaleString();

        document.getElementById('daysNeeded').textContent = daysNeeded;

        document.getElementById('confidenceFill').style.width = confidence + '%';

        document.getElementById('confidenceText').textContent = confidence + '% —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å';

    }, 1200);



    function showPredictionError(message) {

        setTimeout(() => {

            document.querySelector('.prediction-loading').style.display = 'none';

            document.getElementById('predictionCard').innerHTML =

                `<div style="text-align: center; padding: 40px; color: var(--sber-gray-medium);">

                    <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>

                    <p style="font-size: 16px; margin-bottom: 8px;">${message}</p>

                    <p style="font-size: 14px; opacity: 0.7;">–î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞</p>

                </div>`;

        }, 1000);

    }



    function showPredictionSuccess(message) {

        setTimeout(() => {

            document.querySelector('.prediction-loading').style.display = 'none';

            document.getElementById('predictionCard').innerHTML =

                `<div style="text-align: center; padding: 40px;">

                    <div style="font-size: 64px; margin-bottom: 20px;">üéâ</div>

                    <div style="font-size: 28px; font-weight: 900; color: var(--sber-green-dark); margin-bottom: 12px;">${message}</div>

                    <div style="font-size: 16px; color: var(--sber-gray-medium);">–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!</div>

                </div>`;

        }, 1000);

    }



    function showPredictionWarning(message) {

        setTimeout(() => {

            document.querySelector('.prediction-loading').style.display = 'none';

            document.getElementById('predictionResult').style.display = 'block';

            document.getElementById('predictedDate').textContent = '‚ùå –í –ø—Ä–æ—à–ª–æ–º';

            document.getElementById('dailyRate').textContent = dailyRate.toLocaleString();

            document.getElementById('daysNeeded').textContent = '–°–ª–∏—à–∫–æ–º –º–∞–ª–æ';

            document.getElementById('confidenceFill').style.width = '10%';

            document.getElementById('confidenceText').textContent = message;

        }, 1200);

    }

});

</script>
<!-- –ü–†–ï–î–°–ö–ê–ó–ê–ù–ò–ï –î–ê–¢–´ –ó–ê–í–ï–†–®–ï–ù–ò–Ø -->
<div class="prediction-section">
    <h3 class="prediction-title">üéØ –ö–æ–≥–¥–∞ –¥–æ—Å—Ç–∏–≥–Ω–µ—Ç–µ —Ü–µ–ª–∏?</h3>
    <div class="prediction-card" id="predictionCard">
        <div class="prediction-loading">
            <span class="spinner"></span>
            <span>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é...</span>
        </div>
        <div class="prediction-result" id="predictionResult" style="display: none;">
            <div class="prediction-date" id="predictedDate">-</div>
            <div class="prediction-details">
                <span class="detail-line">
                    <span class="detail-label">–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å:</span>
                    <span class="detail-value" id="dailyRate">-</span> ‚ÇΩ/–¥–µ–Ω—å
                </div>
                <span class="detail-line">
                    <span class="detail-label">–û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π:</span>
                    <span class="detail-value" id="daysNeeded">-</span>
                </div>
                <div class="confidence-bar">
                    <div class="confidence-fill" id="confidenceFill" style="width: 0%"></div>
                    <span class="confidence-text" id="confidenceText">0% —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if n.user != session["user"] %}
<div class="action-buttons">
    <a href="/del_user/{{ n.id }}/{{ session['user'] }}" class="btn btn-danger" onclick="return confirm('–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è?')">–ü–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è</a>
</div>
{% endif %}
{% endblock %}
