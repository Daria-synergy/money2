{% extends 'index.html' %}
{% block content %}
<!-- –ò–∫–æ–Ω–∫–∏ –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É -->
<div class="icon-container">
    <a href="/money">
        <img class="img1" src="../static/img/home.png" alt="–ù–∞–∑–∞–¥">
    </a>
    <a href="/logout">
        <img class="img1" src="../static/img/exit.png" alt="–í—ã—Ö–æ–¥">
    </a>
    <a href="#" class="theme-toggle">
        <img class="img1" src="/static/img/set.png" alt="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
    </a>
</div>

<div class="goal-header">
    <div class="goal-image">
        <img src="/static/img/goal.png" alt="–¶–µ–ª—å" class="goal-img">
    </div>
    <div class="goal-content">
        <div class="goal-title">
            <h1>{{ n.title }}</h1>
            <div class="goal-status {{ 'completed' if n.status == '–¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞' else 'in-progress' }}">
                –¶–µ–ª—å {{ n.status }}
            </div>
        </div>
    </div>
</div>

{% with messages = get_flashed_messages() %}
    {% if messages %}
        {% for message in messages %}
            <div class="alert">{{ message }}</div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="goal-stats">
    <div class="stat-tile sum-tile">
        <span class="stat-label">–ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞</span>
        <span class="stat-value">{{ n.sum_ }} ‚ÇΩ</span>
    </div>
    <div class="stat-tile sum-tile">
        <span class="stat-label">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</span>
        <span class="stat-value balance">{{ n.balance }} ‚ÇΩ</span>
    </div>
    <div class="stat-tile sum-tile">
        <span class="stat-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</span>
        <span class="stat-value category">{{ n.cat }}</span>
    </div>
    <div class="stat-tile sum-tile">
        <span class="stat-label">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ</span>
        <span class="stat-value category">{{ n.change }}</span>
    </div>
</div>

{% if n.user == session["user"] %}
<div class="action-buttons">
    <a href="/update/{{ n.id }}" class="btn btn-primary">–û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–ª—å</a>
    <a href="/delete/{{ n.id }}" class="btn btn-danger" onclick="return confirm('–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ? –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –µ–≥–æ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å.')">–£–¥–∞–ª–∏—Ç—å —Ü–µ–ª—å</a>
</div>
{% endif %}

{% if n.status == '–Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞' %}
<div class="balance-controls">
    <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–º</h3>
    <form action="/plus/{{ n.id }}" method="post">
        <div class="balance-inputs">
            <input type="number" id="balanceAmount" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É" min="1" name="b" required>
            <div class="balance-actions">
                <button type="submit" class="btn-balance increase">–£–≤–µ–ª–∏—á–∏—Ç—å</button>
                <button type="submit" class="btn-balance decrease" formaction="/minus/{{ n.id }}">–£–º–µ–Ω—å—à–∏—Ç—å</button>
            </div>
        </div>
    </form>
</div>

{% if n.user == session["user"] %}
<div class="collaborators-section">
    <h3>–°–æ–≤–º–µ—Å—Ç–Ω—ã–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è</h3>

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞ -->
    <div class="form-group">
        <form action="/add_user/{{ n.id }}" method="post" class="collaborator-form">
            <label for="u">–õ–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
            <input type="text"
                   id="u"
                   name="u"
                   required>
            <button type="submit" class="btn">–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</button>
        </form>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ —Ç–µ–∫—É—â–∏—Ö —Å–æ–∞–≤—Ç–æ—Ä–æ–≤ -->
    {% if n.users %}
    <div class="collaborators-list">
        <h4>–£—á–∞—Å—Ç–Ω–∏–∫–∏ ({{ n.users.split(', ')|length }})</h4>
        <div class="users-grid">
            {% for user_login in n.users.split(', ') %}
            <div class="user-item">
                <span class="username">{{ user_login }}</span>
                <a href="/del_user/{{ n.id }}/{{ user_login }}"
                   class="btn btn-danger btn-small"
                   onclick="return confirm('–£–¥–∞–ª–∏—Ç—å {{ user_login }} –∏–∑ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è?')">√ó</a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="empty-state">
        <p>–ù–∏–∫—Ç–æ –µ—â–µ –Ω–µ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—é</p>
    </div>
    {% endif %}
</div>
{% endif %}
{% endif %}

<!-- –ò–°–¢–û–†–ò–Ø + –ì–†–ê–§–ò–ö - –†–ê–ë–û–ß–ê–Ø –í–ï–†–°–ò–Ø -->
<div class="history-chart-container">
    <div class="history-chart-wrapper">
        <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å - –ò—Å—Ç–æ—Ä–∏—è -->
        <div class="history-section">
            <h3 class="chart-title">üìä –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</h3>
            {% if tr %}
            <div class="history-list" id="historyList">
                {% for i in tr %}
                <div class="history-item {{ 'increase' if i.operation == '+' else 'decrease' }}"
                     data-date="{{ i.change }}"
                     data-amount="{{ i.sum_ }}"
                     data-operation="{{ i.operation }}">
                    <div class="history-info">
                        <span class="history-icon">{{ i.operation }}</span>
                        <span class="history-amount">{{ i.sum_ }} ‚ÇΩ</span>
                        <span class="history-date">{{ i.change }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">üìä</div>
                <p>–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—É—Å—Ç–∞</p>
            </div>
            {% endif %}
        </div>

        <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å - –ì—Ä–∞—Ñ–∏–∫ -->
        <div class="chart-section">
            <h3 class="chart-title">üìà –ü—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è</h3>
            <div class="chart-container">
                <canvas id="balanceChart"></canvas>
            </div>
            {% if n.status == '–Ω–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞' %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // üîç –ü–æ–∏—Å–∫ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    const goalSumElement = document.querySelector('.sum-tile:first-child .stat-value');
    const historyItems = document.querySelectorAll('.history-item');

    console.log('=== –ì–ò–ë–†–ò–î–ù–´–ô –ü–†–ï–î–°–ö–ê–ó–ê–¢–ï–õ–¨ v2 ===');
    console.log('–¶–µ–ª—å —ç–ª–µ–º–µ–Ω—Ç:', goalSumElement);
    console.log('–ò—Å—Ç–æ—Ä–∏—è:', historyItems.length);

    if (!goalSumElement || historyItems.length === 0) {
        showPredictionError('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
        return;
    }

    // üéØ –ù–∞–¥—ë–∂–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ —Ü–µ–ª–∏ (3 –º–µ—Ç–æ–¥–∞)
    const rawGoalText = goalSumElement.textContent.trim();
    console.log('–¶–µ–ª—å —Ç–µ–∫—Å—Ç:', rawGoalText);

    let goalSum = parseFloat(rawGoalText.replace(/[^0-9]/g, ''));
    if (isNaN(goalSum)) {
        const match = rawGoalText.match(/[ds]+/);
        goalSum = match ? parseFloat(match[0].replace(/s/g, '')) : NaN;
    }
    if (isNaN(goalSum)) {
        const numbers = rawGoalText.match(/d+/g);
        goalSum = numbers ? parseFloat(numbers[0]) : 0;
    }

    console.log('–¶–µ–ª—å:', goalSum);
    if (isNaN(goalSum) || goalSum <= 0) {
        showPredictionError('–û—à–∏–±–∫–∞ —Ü–µ–ª–∏: "' + rawGoalText + '"');
        return;
    }

    // üìä –ò—Å—Ç–æ—Ä–∏—è —Å –¥–∞—Ç–∞–º–∏
    const history = [];
    for (let item of historyItems) {
        const amount = parseFloat(item.dataset.amount) || 0;
        if (amount > 0) {
            history.push({
                date: item.dataset.date,
                dateObj: new Date(item.dataset.date),
                amount: amount,
                operation: item.dataset.operation
            });
        }
    }

    console.log('–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–π:', history.length);
    if (history.length < 3) {
        showPredictionError('–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 –æ–ø–µ—Ä–∞—Ü–∏–∏');
        return;
    }

    // üí∞ –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å
    let currentBalance = 0;
    for (let item of history) {
        currentBalance += item.operation === '+' ? item.amount : -item.amount;
    }

    console.log('–ë–∞–ª–∞–Ω—Å:', currentBalance);

    if (currentBalance >= goalSum) {
        showPredictionSuccess('üéâ –¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!');
        return;
    }
    if (currentBalance <= 0) {
        showPredictionError('–ë–∞–ª–∞–Ω—Å: ' + Math.round(currentBalance) + ' ‚ÇΩ');
        return;
    }

    // üéØ –ì–ò–ë–†–ò–î–ù–´–ô –ê–õ–ì–û–†–ò–¢–ú
    const CUTOFF_DAYS = 30;
    const cutoffDate = new Date(Date.now() - CUTOFF_DAYS * 24 * 60 * 60 * 1000);

    // –û–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π
    const recentHistory = history.filter(h => h.dateObj >= cutoffDate);
    console.log('–û–ø–µ—Ä–∞—Ü–∏–π –∑–∞ 30 –¥–Ω–µ–π:', recentHistory.length);

    if (recentHistory.length === 0) {
        showPredictionError('–ù–µ—Ç —Å–≤–µ–∂–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (30 –¥–Ω–µ–π)');
        return;
    }

    // –†–∞—Å—á—ë—Ç –¥–Ω–µ–π (–≥–∏–±—Ä–∏–¥)
    const firstDate = recentHistory[0].dateObj;
    const lastDate = recentHistory[recentHistory.length - 1].dateObj;
    const calendarDays = Math.ceil((lastDate - firstDate) / (1000 * 60 * 60 * 24)) + 1;
    const operationsCount = recentHistory.length;
    const daysCount = Math.max(3, operationsCount, calendarDays);

    console.log('–î–Ω–µ–π (–æ–ø–µ—Ä–∞—Ü–∏–π):', operationsCount);
    console.log('–î–Ω–µ–π (–∫–∞–ª–µ–Ω–¥–∞—Ä—å):', calendarDays);
    console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–Ω–µ–π:', daysCount);

    // –ß–∏—Å—Ç—ã–π –ø—Ä–∏—Ä–æ—Å—Ç
    let netGain = 0;
    for (let item of recentHistory) {
        netGain += item.operation === '+' ? item.amount : -item.amount;
    }

    const dailyRate = Math.max(1, Math.round(netGain / daysCount));
    console.log('–°–∫–æ—Ä–æ—Å—Ç—å:', dailyRate, '‚ÇΩ/–¥–µ–Ω—å');

    if (dailyRate <= 0) {
        showPredictionError('–°–∫–æ—Ä–æ—Å—Ç—å: ' + dailyRate + ' ‚ÇΩ/–¥–µ–Ω—å');
        return;
    }

    // üìÖ –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ
    const remaining = goalSum - currentBalance;
    const daysNeeded = Math.ceil(remaining / dailyRate);
    const predictedDate = new Date(lastDate.getTime() + daysNeeded * 24 * 60 * 60 * 1000);

    console.log('–û—Å—Ç–∞—Ç–æ–∫:', remaining);
    console.log('–î–Ω–µ–π –Ω—É–∂–Ω–æ:', daysNeeded);
    console.log('–î–∞—Ç–∞:', predictedDate);

    if (predictedDate < new Date()) {
        showPredictionWarning('–î–∞—Ç–∞ –≤ –ø—Ä–æ—à–ª–æ–º');
        return;
    }
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    const formatter = new Intl.DateTimeFormat('ru-RU', {
        day: 'numeric', month: 'long', year: 'numeric'
    });
    const formattedDate = formatter.format(predictedDate);

    // ‚úÖ –ü–æ–∫–∞–∑–∞—Ç—å
    setTimeout(() => {
        document.querySelector('.prediction-loading').style.display = 'none';
        document.getElementById('predictionResult').style.display = 'block';
        document.getElementById('predictedDate').textContent = formattedDate;
        console.log('‚úÖ –ì–æ—Ç–æ–≤–æ:', formattedDate);
    }, 1200);

    // üõ†Ô∏è –§—É–Ω–∫—Ü–∏–∏ –≤—ã–≤–æ–¥–∞
    function showPredictionError(message) {
        setTimeout(() => {
            const card = document.getElementById('predictionCard');
            if (card) {
                if (message.includes('–ë–∞–ª–∞–Ω—Å:')) {
                    card.innerHTML = '<div style="text-align:center;padding:32px;color:#666">' +
                        '<div style="font-size:48px;margin-bottom:16px">üìä</div>' +
                        '<div style="font-size:18px;margin-bottom:8px;font-weight:500">–°–∫–æ—Ä–æ—Å—Ç—å —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∞—è</div>' +
                        '<div style="font-size:14px;opacity:0.7">–î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π</div>' +
                        '</div>';
                } else {
                    card.innerHTML = '<div style="text-align:center;padding:32px;color:#666">' +
                        '<div style="font-size:48px;margin-bottom:16px">üìä</div>' +
                        '<div style="font-size:18px;margin-bottom:8px;font-weight:500">' + message + '</div>' +
                        '<div style="font-size:14px;opacity:0.7">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ</div>' +
                        '</div>';
                }
            }
        }, 1000);
    }

    function showPredictionSuccess(message) {
        setTimeout(() => {
            const card = document.getElementById('predictionCard');
            if (card) {
                card.innerHTML = '<div style="text-align:center;padding:32px">' +
                    '<div style="font-size:64px;margin-bottom:20px">üéâ</div>' +
                    '<div style="font-size:24px;font-weight:900;color:#166534;margin-bottom:12px">' + message + '</div>' +
                    '<div style="font-size:16px;color:#666">–û—Ç–ª–∏—á–Ω–æ!</div>' +
                    '</div>';
            }
        }, 1000);
    }

    function showPredictionWarning(message) {
        setTimeout(() => {
            const card = document.getElementById('predictionCard');
            if (card) {
                card.innerHTML = '<div style="text-align:center;padding:32px;color:#d97706">' +
                    '<div style="font-size:48px;margin-bottom:16px">‚ö†Ô∏è</div>' +
                    '<div style="font-size:18px;margin-bottom:8px;font-weight:500">' + message + '</div>' +
                    '<div style="font-size:14px;opacity:0.7">–î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π</div>' +
                    '</div>';
            }
        }, 1000);
    }
});
</script>
<div class="prediction-section" style="margin-top: 60px;">
    <div class="prediction-title-center">üéØ –ö–æ–≥–¥–∞ –¥–æ—Å—Ç–∏–≥–Ω–µ—Ç–µ —Ü–µ–ª–∏?</div>
    <div class="prediction-card" id="predictionCard">
        <div class="prediction-loading">
            <span class="spinner"></span>
            <span>–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é...</span>
        </div>
        <div class="prediction-result" id="predictionResult" style="display: none;">
            <!-- ‚úÖ –¢–û–õ–¨–ö–û –î–ê–¢–ê -->
            <div class="prediction-date" id="predictedDate">-</div>
        </div>
    </div>
</div>

{% endif %}
        </div>
    </div>
</div>
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const historyList = document.getElementById('historyList');
    if (!historyList || historyList.children.length === 0) {
        console.log('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞');
        return;
    }

    const historyItems = document.querySelectorAll('.history-item');
    const goalSumElement = document.querySelector('.stat-value'); // –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞
    const goalSumText = goalSumElement ? goalSumElement.textContent.replace(' ‚ÇΩ', '').replace(/,/g, '') : 0;
    const maxBalance = parseFloat(goalSumText) || 10000;

    console.log('–ù–∞–π–¥–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏—Å—Ç–æ—Ä–∏–∏: ' + historyItems.length);
    console.log('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å —Ü–µ–ª–∏: ' + maxBalance);

    const labels = [];
    const balanceData = [];
    const colors = [];
    let currentBalance = 0;

    Array.from(historyItems).forEach(function(item) {
        const date = item.dataset.date || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
        const amount = parseFloat(item.dataset.amount) || 0;
        const operation = item.dataset.operation;

        // –û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø: 0 <= –±–∞–ª–∞–Ω—Å <= –∏—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞
        currentBalance += (operation === '+' ? amount : -amount);
        currentBalance = Math.max(0, Math.min(currentBalance, maxBalance));

        labels.push(date);
        balanceData.push(Math.round(currentBalance));
        colors.push(operation === '+' ? '#57B446' : '#FF6B35');
    });

    console.log('–î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞: ', { labels: labels, balanceData: balanceData });

    const canvas = document.getElementById('balanceChart');
    if (!canvas) {
        console.error('Canvas –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        return;
    }

    const ctx = canvas.getContext('2d');

    if (window.balanceChartInstance) {
        window.balanceChartInstance.destroy();
    }

    window.balanceChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '–ë–∞–ª–∞–Ω—Å',
                data: balanceData,
                borderColor: '#57B446',
                backgroundColor: 'rgba(87, 180, 70, 0.15)',
                borderWidth: 4,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: colors,
                pointBorderColor: '#fff',
                pointBorderWidth: 3,
                pointRadius: 8,
                pointHoverRadius: 12
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.9)',
                    titleColor: 'white',
                    bodyColor: 'white',
                    cornerRadius: 8,
                    callbacks: {
                        label: function(context) {
                            return '–ë–∞–ª–∞–Ω—Å: ' + context.parsed.y.toLocaleString() + ' ‚ÇΩ';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: maxBalance,
                    grid: { color: 'rgba(0,0,0,0.05)' },
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString() + ' ‚ÇΩ';
                        }
                    }
                },
                x: {
                    grid: { display: false }
                }
            },
            animation: {
                duration: 1500,
                easing: 'easeOutQuart'
            }
        }
    });

    console.log('–ì—Ä–∞—Ñ–∏–∫ —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏!');
});
</script>

{% if n.user != session["user"] %}
<div class="action-buttons">
    <a href="/del_user/{{ n.id }}/{{ session['user'] }}" class="btn btn-danger" onclick="return confirm('–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è?')">–ü–æ–∫–∏–Ω—É—Ç—å –≥—Ä—É–ø–ø—É –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è</a>
</div>
{% endif %}
{% endblock %}